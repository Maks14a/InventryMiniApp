<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Iventry App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: var(--tg-theme-bg-color, #1a1a1a); color: var(--tg-theme-text-color, #fff); }
        .glass { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .hidden { display: none; }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden">

    <div id="screen-list" class="flex flex-col h-full p-4">
        <h1 class="text-xl font-bold mb-4">üì∏ –ú–æ–∏ –ê–ª—å–±–æ–º—ã</h1>
        <div id="album-container" class="space-y-3 overflow-y-auto flex-grow">
            </div>
    </div>

    <div id="screen-album" class="hidden flex flex-col h-full">
        <div class="p-4 border-b border-white/10 flex items-center">
            <button onclick="backToList()" class="mr-4 text-blue-400">‚Üê –ù–∞–∑–∞–¥</button>
            <h1 id="current-album-name" class="font-bold truncate text-lg">–ù–∞–∑–≤–∞–Ω–∏–µ</h1>
        </div>
        
        <div id="photo-container" class="flex-grow overflow-y-auto p-2 grid grid-cols-3 gap-1">
            </div>

        <div class="glass p-4 rounded-t-3xl grid grid-cols-3 gap-3 shadow-2xl">
            <label class="flex flex-col items-center p-2 rounded-xl active:bg-white/10">
                <span class="text-2xl">üñº</span>
                <span class="text-[10px] uppercase font-bold">–ì–∞–ª–µ—Ä–µ—è</span>
                <input type="file" accept="image/*" multiple class="hidden" onchange="uploadPhoto(this)">
            </label>
            <label class="flex flex-col items-center p-2 rounded-xl bg-blue-600 active:scale-95">
                <span class="text-2xl text-white">üì∏</span>
                <span class="text-[10px] uppercase font-bold text-white">–ö–∞–º–µ—Ä–∞</span>
                <input type="file" accept="image/*" capture="environment" class="hidden" onchange="uploadPhoto(this)">
            </label>
            <button onclick="shareLink()" class="flex flex-col items-center p-2 rounded-xl active:bg-white/10">
                <span class="text-2xl">üîó</span>
                <span class="text-[10px] uppercase font-bold">–°—Å—ã–ª–∫–∞</span>
            </button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        const API_BASE = "http://localhost:8080"; 
        const userId = tg.initDataUnsafe?.user?.id || 123;
        let activeAlbumCode = null;

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –∞–ª—å–±–æ–º–æ–≤
        async function loadAlbums() {
            const container = document.getElementById('album-container');
            try {
                const res = await fetch(`${API_BASE}/api/albums/${userId}`);
                const data = await res.json();
                container.innerHTML = data.map(a => `
                    <div onclick="openAlbum('${a.code}', '${a.name}')" class="glass p-4 rounded-2xl flex justify-between active:scale-95 transition">
                        <span>${a.name}</span>
                        <span class="opacity-30">‚Üí</span>
                    </div>
                `).join('');
            } catch (e) { container.innerHTML = "–û—à–∏–±–∫–∞ API"; }
        }

        // –í—Ö–æ–¥ –≤ –∞–ª—å–±–æ–º
        async function openAlbum(code, name) {
            activeAlbumCode = code;
            document.getElementById('current-album-name').innerText = name;
            document.getElementById('screen-list').classList.add('hidden');
            document.getElementById('screen-album').classList.remove('hidden');
            
            // –ì—Ä—É–∑–∏–º —Ñ–æ—Ç–∫–∏
            const res = await fetch(`${API_BASE}/api/photos/${code}`);
            const photos = await res.json();
            const container = document.getElementById('photo-container');
            if (photos.length === 0) {
                container.innerHTML = `<p class="col-span-3 text-center opacity-30 mt-10 text-sm">–í —ç—Ç–æ–º –∞–ª—å–±–æ–º–µ –µ—â–µ –Ω–µ—Ç —Ñ–æ—Ç–æ</p>`;
            } else {
                container.innerHTML = photos.map(url => `<img src="${url}" class="w-full h-32 object-cover rounded">`).join('');
            }
        }

        function backToList() {
            document.getElementById('screen-list').classList.remove('hidden');
            document.getElementById('screen-album').classList.add('hidden');
        }

        async function uploadPhoto(input) {
            if (input.files.length > 0) {
                tg.showConfirm(`–ó–∞–≥—Ä—É–∑–∏—Ç—å ${input.files.length} —Ñ–æ—Ç–æ?`, (ok) => {
                    if(ok) tg.showAlert("–§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã! (–ë—ç–∫–µ–Ω–¥ —Å–æ—Ö—Ä–∞–Ω–∏–ª —Å—Å—ã–ª–∫—É)");
                });
            }
        }

        function shareLink() {
            tg.switchInlineQuery(`https://t.me/8589049869?start=alb_${activeAlbumCode}`);
        }

        loadAlbums();
    </script>
</body>
</html>
