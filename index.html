<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background:#000; color:#fff; margin:0; }
    .glass { background: rgba(255,255,255,.08); backdrop-filter: blur(15px); }
    #full-view { display:none; position:fixed; inset:0; background:#000; z-index:9999; justify-content:center; align-items:center; }
    #full-view img { max-width:100%; max-height:100%; object-fit:contain; }
  </style>
</head>

<body class="h-screen flex flex-col overflow-hidden">

  <div id="screen-list" class="p-4 flex-grow overflow-y-auto bg-[#1a1a1a]">
    <h1 class="text-2xl font-bold mb-6">üì∏ –ê–ª—å–±–æ–º—ã</h1>
    <div id="albums-list" class="grid gap-3"></div>
  </div>

  <div id="screen-album" class="hidden flex flex-col h-full bg-[#111]">
    <div class="p-4 flex items-center justify-between border-b border-white/5">
      <button onclick="closeAlb()" class="text-2xl">‚úï</button>
      <span id="header-title" class="font-bold truncate max-w-[160px]"></span>
      <button onclick="shareLink()" class="text-blue-400 font-bold">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
    </div>

    <div id="photo-grid" class="flex-grow overflow-y-auto p-1 grid grid-cols-3 gap-1"></div>

    <!-- –†–∞–∑–¥–µ–ª—ë–Ω–Ω—ã–µ –∏–Ω–ø—É—Ç—ã -->
    <input id="galleryInput" type="file" accept="image/*" multiple class="hidden">
    <input id="cameraInput" type="file" accept="image/*" capture="environment" class="hidden">

    <div class="glass p-6 pb-10 grid grid-cols-3 gap-4 rounded-t-3xl">
      <button onclick="openGallery()" class="flex flex-col items-center gap-1">
        <span class="text-2xl">üñº</span>
        <span class="text-xs opacity-70">–ì–∞–ª–µ—Ä–µ—è</span>
      </button>

      <button onclick="openCamera()" class="flex flex-col items-center gap-1">
        <span class="text-3xl bg-blue-600 rounded-full w-12 h-12 flex items-center justify-center">üì∏</span>
        <span class="text-xs opacity-70">–ö–∞–º–µ—Ä–∞</span>
      </button>

      <button onclick="shareLink()" class="flex flex-col items-center gap-1">
        <span class="text-2xl">üîó</span>
        <span class="text-xs opacity-70">–õ–∏–Ω–∫</span>
      </button>
    </div>
  </div>

  <div id="full-view" onclick="this.style.display='none'">
    <img id="full-img" src="">
    <div class="absolute top-5 right-5 text-2xl font-bold">‚úï</div>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    const API = "https://bot13-iventry.amvera.io";

    const userId = tg.initDataUnsafe?.user?.id || 123;

    let currentAlbumCode = "";
    let currentAlbumName = "";

    tg.expand();

    const galleryInput = document.getElementById("galleryInput");
    const cameraInput = document.getElementById("cameraInput");

    galleryInput.addEventListener("change", () => uploadFiles(galleryInput));
    cameraInput.addEventListener("change", () => uploadFiles(cameraInput));

    function openGallery() {
      if (!currentAlbumCode) return;
      galleryInput.click();
    }

    function openCamera() {
      if (!currentAlbumCode) return;
      cameraInput.click();
    }

    async function loadAlbums() {
      const r = await fetch(`${API}/api/albums/${userId}`);
      const d = await r.json();

      document.getElementById("albums-list").innerHTML = d.map(a => `
        <div onclick="openAlb('${a.code}', '${escapeHtml(a.name)}')" class="glass p-4 rounded-xl flex justify-between">
          <span>${escapeHtml(a.name)}</span><span>‚Üí</span>
        </div>
      `).join("");
    }

    async function openAlb(code, name) {
      currentAlbumCode = code;
      currentAlbumName = name;

      document.getElementById("header-title").innerText = name;
      document.getElementById("screen-list").style.display = "none";
      document.getElementById("screen-album").style.display = "flex";

      const r = await fetch(`${API}/api/photos/${code}`);
      const photos = await r.json();

      document.getElementById("photo-grid").innerHTML = photos.map(url => {
        const u = normalizeUrl(url);
        return `<img src="${u}"
                    referrerpolicy="no-referrer"
                    loading="lazy"
                    decoding="async"
                    onclick="showFull('${u}')"
                    class="w-full h-32 object-cover">`;
      }).join("");
    }

    function normalizeUrl(url) {
      if (!url) return "";
      if (url.startsWith("http://") || url.startsWith("https://")) return url;
      if (url.startsWith("/")) return API + url;
      return API + "/" + url;
    }

    function showFull(url) {
      document.getElementById("full-img").src = url;
      document.getElementById("full-view").style.display = "flex";
    }

    function closeAlb() {
      document.getElementById("screen-list").style.display = "block";
      document.getElementById("screen-album").style.display = "none";
      currentAlbumCode = "";
      currentAlbumName = "";
    }

    async function uploadFiles(inputEl) {
      const files = Array.from(inputEl.files || []);
      if (!files.length) return;

      tg.MainButton.setText("–ó–∞–≥—Ä—É–∑–∫–∞...").show();

      try {
        for (const f of files) {
          const fd = new FormData();
          fd.append("file", f);
          fd.append("album_code", currentAlbumCode);
          fd.append("user_id", userId);

          const resp = await fetch(`${API}/api/upload`, { method: "POST", body: fd });
          if (!resp.ok) {
            const t = await resp.text();
            console.log("upload error:", t);
          }
        }

        await openAlb(currentAlbumCode, currentAlbumName);
      } finally {
        tg.MainButton.hide();
        inputEl.value = "";
      }
    }

    function shareLink() {
      if (!currentAlbumCode) return;
      const link = `https://t.me/Iventry_Bot?start=alb_${currentAlbumCode}`;
      tg.openTelegramLink(
        `https://t.me/share/url?url=${encodeURIComponent(link)}&text=${encodeURIComponent("–ó–∞—Ö–æ–¥–∏ –≤ –º–æ–π –∞–ª—å–±–æ–º!")}`
      );
    }

    function escapeHtml(s) {
      return String(s || "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    loadAlbums();
  </script>

</body>
</html>
