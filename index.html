<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: var(--tg-theme-bg-color, #1a1a1a); color: var(--tg-theme-text-color, #fff); }
        .glass { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">
    <div id="list-screen" class="p-4 flex-grow overflow-y-auto">
        <h1 class="text-xl font-bold mb-4">–ú–æ–∏ –ê–ª—å–±–æ–º—ã</h1>
        <div id="albums" class="space-y-2"></div>
    </div>
    <div id="album-screen" class="hidden flex flex-col h-full">
        <div class="p-4 border-b border-white/10 flex items-center">
            <button onclick="showList()" class="text-blue-400 mr-4">‚Üê</button>
            <h2 id="alb-title" class="font-bold"></h2>
        </div>
        <div id="photos" class="flex-grow overflow-y-auto p-2 grid grid-cols-3 gap-1"></div>
        <div class="glass p-6 rounded-t-3xl grid grid-cols-3 gap-4">
            <label class="flex flex-col items-center">
                <span>üñº</span><span class="text-[10px]">–ì–∞–ª–µ—Ä–µ—è</span>
                <input type="file" accept="image/*" multiple class="hidden" onchange="up(this)">
            </label>
            <label class="flex flex-col items-center bg-blue-600 rounded-xl p-2">
                <span>üì∏</span><span class="text-[10px]">–ö–∞–º–µ—Ä–∞</span>
                <input type="file" accept="image/*" capture="environment" class="hidden" onchange="up(this)">
            </label>
            <button onclick="share()"><span>üîó</span><span class="text-[10px]">–°—Å—ã–ª–∫–∞</span></button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        const API = "http://localhost:8080";
        const uid = tg.initDataUnsafe?.user?.id || 123;
        let curCode = null;

        async function load() {
            const r = await fetch(`${API}/api/albums/${uid}`);
            const d = await r.json();
            document.getElementById('albums').innerHTML = d.map(a => `
                <div onclick="openAlb('${a.code}','${a.name}')" class="glass p-4 rounded-xl">${a.name}</div>
            `).join('');
        }

        async function openAlb(code, name) {
            curCode = code;
            document.getElementById('alb-title').innerText = name;
            document.getElementById('list-screen').classList.add('hidden');
            document.getElementById('album-screen').classList.remove('hidden');
            const r = await fetch(`${API}/api/photos/${code}`);
            const ph = await r.json();
            document.getElementById('photos').innerHTML = ph.map(u => `<img src="${u}" class="w-full h-24 object-cover rounded">`).join('');
        }

        function showList() {
            document.getElementById('list-screen').classList.remove('hidden');
            document.getElementById('album-screen').classList.add('hidden');
        }

        async function up(input) {
            if (!input.files[0]) return;
            const fd = new FormData();
            fd.append('file', input.files[0]);
            fd.append('album_code', curCode);
            fd.append('user_id', uid);
            await fetch(`${API}/api/upload`, { method:'POST', body:fd });
            openAlb(curCode, document.getElementById('alb-title').innerText);
        }

        function share() {
            tg.switchInlineQuery(`https://t.me/8589049869?start=alb_${curCode}`);
        }

        load();
        tg.expand();
    </script>
</body>
</html>
