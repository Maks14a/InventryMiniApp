<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Iventry App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --bg-color: var(--tg-theme-bg-color, #1a1a1a);
            --text-color: var(--tg-theme-text-color, #ffffff);
            --hint-color: var(--tg-theme-hint-color, #aaaaaa);
            --button-color: var(--tg-theme-button-color, #248bcf);
        }
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden;
        }
        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .active-album {
            border: 2px solid var(--button-color) !important;
            background: rgba(36, 139, 207, 0.1);
        }
        .tab-bar {
            padding-bottom: env(safe-area-inset-bottom);
        }
    </style>
</head>
<body class="flex flex-col h-screen">

    <div class="p-4 border-b border-white/10 flex justify-between items-center">
        <h1 class="text-lg font-bold">–ú–æ–∏ –ê–ª—å–±–æ–º—ã</h1>
        <span id="user-name" class="text-xs text-blue-400"></span>
    </div>

    <div id="album-list" class="flex-grow overflow-y-auto p-4 space-y-3">
        <div class="animate-pulse flex space-x-4">
            <div class="flex-1 space-y-4 py-1">
                <div class="h-12 bg-white/10 rounded-xl"></div>
                <div class="h-12 bg-white/10 rounded-xl"></div>
            </div>
        </div>
    </div>

    <div class="glass tab-bar p-4 rounded-t-3xl shadow-2xl">
        <div class="grid grid-cols-3 gap-3">
            <label class="flex flex-col items-center justify-center p-3 rounded-2xl hover:bg-white/5 transition active:scale-95 cursor-pointer">
                <span class="text-2xl mb-1">üñº</span>
                <span class="text-[10px] uppercase font-bold opacity-60">–ì–∞–ª–µ—Ä–µ—è</span>
                <input type="file" accept="image/*" multiple class="hidden" onchange="handleFiles(this)">
            </label>

            <label class="flex flex-col items-center justify-center p-3 rounded-2xl bg-blue-600 hover:bg-blue-500 transition active:scale-95 cursor-pointer shadow-lg shadow-blue-900/20">
                <span class="text-2xl mb-1 text-white">üì∏</span>
                <span class="text-[10px] uppercase font-bold text-white">–ö–∞–º–µ—Ä–∞</span>
                <input type="file" accept="image/*" capture="environment" class="hidden" onchange="handleFiles(this)">
            </label>

            <button onclick="shareInvite()" class="flex flex-col items-center justify-center p-3 rounded-2xl hover:bg-white/5 transition active:scale-95">
                <span class="text-2xl mb-1">üîó</span>
                <span class="text-[10px] uppercase font-bold opacity-60">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</span>
            </button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.ready();

        const API_BASE = "http://localhost:8080"; // –ó–ê–ú–ï–ù–ò –ù–ê –°–í–û–ô URL
        let selectedAlbumCode = null;
        const userId = tg.initDataUnsafe?.user?.id || 123; // 123 –¥–ª—è —Ç–µ—Å—Ç–æ–≤ –≤ –±—Ä–∞—É–∑–µ—Ä–µ
        
        document.getElementById('user-name').innerText = tg.initDataUnsafe?.user?.first_name || "Guest";

        async function loadAlbums() {
            const list = document.getElementById('album-list');
            try {
                const res = await fetch(`${API_BASE}/api/albums/${userId}`);
                const albums = await res.json();
                
                if (!albums || albums.length === 0) {
                    list.innerHTML = `<div class="text-center opacity-40 mt-10">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∞–ª—å–±–æ–º–æ–≤.<br>–°–æ–∑–¥–∞–π—Ç–µ –æ–¥–∏–Ω –≤ –±–æ—Ç–µ!</div>`;
                    return;
                }

                list.innerHTML = albums.map(a => `
                    <div id="alb-${a.code}" onclick="selectAlbum('${a.code}')" 
                         class="glass p-4 rounded-2xl flex justify-between items-center transition active:scale-[0.98]">
                        <div>
                            <div class="font-bold">${a.name}</div>
                            <div class="text-[10px] opacity-40 font-mono italic">ID: ${a.code}</div>
                        </div>
                        <div class="text-blue-500 opacity-0 check-mark">‚úì</div>
                    </div>
                `).join('');
            } catch (e) {
                list.innerHTML = `<div class="text-red-400 text-center">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏. –ü—Ä–æ–≤–µ—Ä—å API.</div>`;
            }
        }

        function selectAlbum(code) {
            selectedAlbumCode = code;
            document.querySelectorAll('#album-list > div').forEach(el => {
                el.classList.remove('active-album');
                el.querySelector('.check-mark').style.opacity = '0';
            });
            const active = document.getElementById(`alb-${code}`);
            active.classList.add('active-album');
            active.querySelector('.check-mark').style.opacity = '1';
            tg.HapticFeedback.impactOccurred('light');
        }

        function handleFiles(input) {
            if (!selectedAlbumCode) {
                tg.showAlert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ –∞–ª—å–±–æ–º –∏–∑ —Å–ø–∏—Å–∫–∞ –≤—ã—à–µ!");
                return;
            }
            const files = input.files;
            if (files.length > 0) {
                tg.showConfirm(`–ó–∞–≥—Ä—É–∑–∏—Ç—å ${files.length} —Ñ–æ—Ç–æ –≤ –∞–ª—å–±–æ–º?`, (ok) => {
                    if (ok) {
                        // –¢—É—Ç –±—É–¥–µ—Ç –ª–æ–≥–∏–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–∞–π–ª–æ–≤ –Ω–∞ —Ç–≤–æ–π API
                        tg.showAlert("–§–æ—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã! (–ó–¥–µ—Å—å –±—É–¥–µ—Ç fetch)");
                    }
                });
            }
        }

        function shareInvite() {
            if (!selectedAlbumCode) {
                tg.showAlert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ –∞–ª—å–±–æ–º, –∫–æ—Ç–æ—Ä—ã–º —Ö–æ—á–µ—à—å –ø–æ–¥–µ–ª–∏—Ç—å—Å—è!");
                return;
            }
            const link = `https://t.me/8589049869?start=alb_${selectedAlbumCode}`;
            tg.switchInlineQuery(link);
        }

        loadAlbums();
    </script>
</body>
</html>
