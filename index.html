import os
import asyncio
import uuid
import random
from datetime import datetime

import psycopg2
from dotenv import load_dotenv

from aiogram import Bot, Dispatcher, types, F
from aiogram.filters import CommandStart
from aiogram.utils.keyboard import InlineKeyboardBuilder
from aiogram.fsm.state import State, StatesGroup
from aiogram.fsm.context import FSMContext
from aiogram.types.web_app_info import WebAppInfo

load_dotenv()


def env_str(name: str) -> str:
    val = os.getenv(name)
    if not val:
        raise RuntimeError(f"{name} –Ω–µ –∑–∞–¥–∞–Ω")
    return val


BOT_TOKEN: str = env_str("BOT_TOKEN")
MINI_APP_URL: str = env_str("MINI_APP_URL")


class CreateAlbum(StatesGroup):
    waiting_for_name = State()


def get_db_connection():
    return psycopg2.connect(
        dbname=env_str("DB_NAME"),
        user=env_str("DB_USER"),
        password=env_str("DB_PASSWORD"),
        host=env_str("DB_HOST"),
        port=int(os.getenv("DB_PORT", "5432")),
        sslmode=os.getenv("DB_SSLMODE", "require"),
        connect_timeout=10,
    )


def ensure_schema():
    conn = get_db_connection()
    cur = conn.cursor()

    cur.execute(
        """
        CREATE TABLE IF NOT EXISTS albums (
            id SERIAL PRIMARY KEY,
            name TEXT NOT NULL,
            owner_id BIGINT NOT NULL,
            invite_code TEXT UNIQUE NOT NULL
        );
        """
    )

    cur.execute(
        """
        CREATE TABLE IF NOT EXISTS album_members (
            album_code TEXT NOT NULL,
            user_id BIGINT NOT NULL,
            can_upload BOOLEAN DEFAULT TRUE,
            can_delete BOOLEAN DEFAULT FALSE,
            username TEXT,
            first_name TEXT,
            last_name TEXT,
            added_at TIMESTAMP DEFAULT NOW(),
            PRIMARY KEY (album_code, user_id)
        );
        """
    )

    cur.execute("ALTER TABLE album_members ADD COLUMN IF NOT EXISTS can_upload BOOLEAN DEFAULT TRUE;")
    cur.execute("ALTER TABLE album_members ADD COLUMN IF NOT EXISTS can_delete BOOLEAN DEFAULT FALSE;")
    cur.execute("ALTER TABLE album_members ADD COLUMN IF NOT EXISTS username TEXT;")
    cur.execute("ALTER TABLE album_members ADD COLUMN IF NOT EXISTS first_name TEXT;")
    cur.execute("ALTER TABLE album_members ADD COLUMN IF NOT EXISTS last_name TEXT;")
    cur.execute("ALTER TABLE album_members ADD COLUMN IF NOT EXISTS added_at TIMESTAMP DEFAULT NOW();")

    cur.execute(
        """
        CREATE TABLE IF NOT EXISTS album_invites (
            token TEXT PRIMARY KEY,
            album_code TEXT NOT NULL,
            created_by BIGINT NOT NULL,
            can_upload BOOLEAN DEFAULT TRUE,
            can_delete BOOLEAN DEFAULT FALSE,
            created_at TIMESTAMP DEFAULT NOW(),
            expires_at TIMESTAMP NULL,
            max_uses INT DEFAULT 1,
            used_count INT DEFAULT 0
        );
        """
    )

    cur.execute(
        """
        CREATE TABLE IF NOT EXISTS album_invite_uses (
            token TEXT NOT NULL,
            user_id BIGINT NOT NULL,
            used_at TIMESTAMP DEFAULT NOW(),
            PRIMARY KEY (token, user_id)
        );
        """
    )

    conn.commit()
    cur.close()
    conn.close()


bot = Bot(token=BOT_TOKEN)
dp = Dispatcher()

# request_id -> data
PENDING_PICK: dict[int, dict] = {}


def webapp_kb():
    kb = InlineKeyboardBuilder()
    kb.row(types.InlineKeyboardButton(text="üñº –û—Ç–∫—Ä—ã—Ç—å –º–∏–Ω–∏-–∞–ø–ø", web_app=WebAppInfo(url=MINI_APP_URL)))
    return kb.as_markup()


def _get_album_owner(album_code: str) -> int | None:
    conn = get_db_connection()
    cur = conn.cursor()
    cur.execute("SELECT owner_id FROM albums WHERE invite_code=%s LIMIT 1", (album_code,))
    row = cur.fetchone()
    cur.close()
    conn.close()
    return int(row[0]) if row else None


@dp.message(CommandStart())
async def start_handler(message: types.Message):
    ensure_schema()

    args = (message.text or "").split()
    payload = args[1] if len(args) > 1 else ""

    if not message.from_user:
        await message.answer("–ù–µ —Å–º–æ–≥ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.")
        return

    user = message.from_user
    user_id = user.id
    username = user.username
    first_name = user.first_name
    last_name = user.last_name

    # --- 1) pick_ : "–ø–æ–¥–µ–ª–∏—Ç—å—Å—è —á–µ–ª–æ–≤–µ–∫–æ–º –±–æ—Ç—É" (–≤—ã–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ request_user) ---
    # payload: pick_<albumCode>_<flags>   flags: "00/10/11"
    if payload.startswith("pick_"):
        parts = payload.split("_")
        if len(parts) < 2:
            await message.answer("‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—Å—ã–ª–∫–∞.")
            return

        album_code = parts[1]
        flags = parts[2] if len(parts) >= 3 else "10"

        can_upload = (len(flags) >= 1 and flags[0] == "1")
        can_delete = (len(flags) >= 2 and flags[1] == "1")

        owner_id = _get_album_owner(album_code)
        if owner_id is None:
            await message.answer("‚ùå –ê–ª—å–±–æ–º –Ω–µ –Ω–∞–π–¥–µ–Ω.")
            return
        if int(owner_id) != int(user_id):
            await message.answer("üö´ –≠—Ç—É —Ñ—É–Ω–∫—Ü–∏—é –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü –∞–ª—å–±–æ–º–∞.")
            return

        req_id = random.randint(100000, 999999999)
        PENDING_PICK[req_id] = {
            "album_code": album_code,
            "owner_id": user_id,
            "can_upload": bool(can_upload),
            "can_delete": bool(can_delete),
        }

        # –ö–Ω–æ–ø–∫–∞ –≤—ã–±–æ—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (Telegram Request User)
        kb = types.ReplyKeyboardMarkup(
            keyboard=[
                [
                    types.KeyboardButton(
                        text="üë§ –í—ã–±—Ä–∞—Ç—å —á–µ–ª–æ–≤–µ–∫–∞",
                        request_user=types.KeyboardButtonRequestUser(
                            request_id=req_id,
                            user_is_bot=False,
                        ),
                    )
                ],
                [types.KeyboardButton(text="‚ùå –û—Ç–º–µ–Ω–∞")],
            ],
            resize_keyboard=True,
            one_time_keyboard=True,
        )

        rights = []
        if can_upload:
            rights.append("–∑–∞–≥—Ä—É–∑–∫–∞")
        if can_delete:
            rights.append("—É–¥–∞–ª–µ–Ω–∏–µ")
        rights_txt = ", ".join(rights) if rights else "—Ç–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä"

        await message.answer(
            f"–û–∫! –ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ –∏ –≤—ã–±–µ—Ä–∏ —á–µ–ª–æ–≤–µ–∫–∞.\n"
            f"–ü—Ä–∞–≤–∞ –¥–ª—è –¥–æ–±–∞–≤–ª—è–µ–º–æ–≥–æ: **{rights_txt}**",
            reply_markup=kb,
            parse_mode="Markdown",
        )
        return

    # --- 2) inv_ : –∏–Ω–≤–∞–π—Ç-—Å—Å—ã–ª–∫–∞ —Å –ø—Ä–∞–≤–∞–º–∏/–ª–∏–º–∏—Ç–æ–º ---
    if payload.startswith("inv_"):
        token = payload.replace("inv_", "", 1).strip()

        try:
            conn = get_db_connection()
            cur = conn.cursor()

            cur.execute(
                """
                SELECT album_code, can_upload, can_delete, expires_at, max_uses, used_count
                FROM album_invites
                WHERE token=%s
                FOR UPDATE
                """,
                (token,),
            )
            row = cur.fetchone()
            if not row:
                conn.rollback()
                cur.close()
                conn.close()
                await message.answer("‚ùå –ò–Ω–≤–∞–π—Ç-—Å—Å—ã–ª–∫–∞ –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞ –∏–ª–∏ —É–¥–∞–ª–µ–Ω–∞.")
                return

            album_code, can_upload, can_delete, expires_at, max_uses, used_count = row
            album_code = str(album_code)

            if expires_at is not None and datetime.utcnow() > expires_at:
                conn.rollback()
                cur.close()
                conn.close()
                await message.answer("‚è≥ –ò–Ω–≤–∞–π—Ç-—Å—Å—ã–ª–∫–∞ –∏—Å—Ç–µ–∫–ª–∞. –ü–æ–ø—Ä–æ—Å–∏ –Ω–æ–≤—É—é.")
                return

            # –ø—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª –ª–∏ —É–∂–µ —ç—Ç–æ—Ç —é–∑–µ—Ä
            cur.execute(
                "SELECT 1 FROM album_invite_uses WHERE token=%s AND user_id=%s LIMIT 1",
                (token, user_id),
            )
            already_used = cur.fetchone() is not None

            mu = int(max_uses) if max_uses is not None else 1  # 0 = –±–µ–∑ –ª–∏–º–∏—Ç–∞
            uc = int(used_count) if used_count is not None else 0

            if not already_used and mu != 0 and uc >= mu:
                conn.rollback()
                cur.close()
                conn.close()
                await message.answer("üö´ –õ–∏–º–∏—Ç –ø–æ —ç—Ç–æ–π —Å—Å—ã–ª–∫–µ –∑–∞–∫–æ–Ω—á–∏–ª—Å—è. –ü–æ–ø—Ä–æ—Å–∏ –Ω–æ–≤—É—é.")
                return

            if not already_used:
                cur.execute(
                    """
                    INSERT INTO album_invite_uses (token, user_id)
                    VALUES (%s,%s)
                    ON CONFLICT (token, user_id) DO NOTHING
                    """,
                    (token, user_id),
                )

                if mu == 0:
                    cur.execute("UPDATE album_invites SET used_count = used_count + 1 WHERE token=%s", (token,))
                else:
                    cur.execute(
                        """
                        UPDATE album_invites
                        SET used_count = used_count + 1
                        WHERE token=%s AND used_count < max_uses
                        """,
                        (token,),
                    )
                    if cur.rowcount == 0:
                        conn.rollback()
                        cur.close()
                        conn.close()
                        await message.answer("üö´ –õ–∏–º–∏—Ç –ø–æ —ç—Ç–æ–π —Å—Å—ã–ª–∫–µ –∑–∞–∫–æ–Ω—á–∏–ª—Å—è. –ü–æ–ø—Ä–æ—Å–∏ –Ω–æ–≤—É—é.")
                        return

            cur.execute("SELECT name, owner_id FROM albums WHERE invite_code=%s LIMIT 1", (album_code,))
            arow = cur.fetchone()
            if not arow:
                conn.rollback()
                cur.close()
                conn.close()
                await message.answer("‚ùå –ê–ª—å–±–æ–º –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–ø—Ä–æ—Å–∏ –Ω–æ–≤—É—é —Å—Å—ã–ª–∫—É.")
                return

            album_name, owner_id = arow

            if int(owner_id) != int(user_id):
                cur.execute(
                    """
                    INSERT INTO album_members (album_code, user_id, can_upload, can_delete, username, first_name, last_name)
                    VALUES (%s,%s,%s,%s,%s,%s,%s)
                    ON CONFLICT (album_code, user_id)
                    DO UPDATE SET
                        can_upload = EXCLUDED.can_upload,
                        can_delete = EXCLUDED.can_delete,
                        username = COALESCE(EXCLUDED.username, album_members.username),
                        first_name = COALESCE(EXCLUDED.first_name, album_members.first_name),
                        last_name = COALESCE(EXCLUDED.last_name, album_members.last_name)
                    """,
                    (album_code, user_id, bool(can_upload), bool(can_delete), username, first_name, last_name),
                )

            conn.commit()
            cur.close()
            conn.close()

            rights = []
            if bool(can_upload):
                rights.append("–∑–∞–≥—Ä—É–∑–∫–∞")
            if bool(can_delete):
                rights.append("—É–¥–∞–ª–µ–Ω–∏–µ")
            rights_txt = ", ".join(rights) if rights else "—Ç–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä"

            await message.answer(
                f"‚úÖ –¢—ã –¥–æ–±–∞–≤–ª–µ–Ω(–∞) –≤ –∞–ª—å–±–æ–º ¬´{album_name}¬ª\n–ü—Ä–∞–≤–∞: {rights_txt}\n–û—Ç–∫—Ä–æ–π –º–∏–Ω–∏-–∞–ø–ø: üëá",
                reply_markup=webapp_kb(),
            )
            return

        except Exception as e:
            await message.answer(f"‚ùå –û—à–∏–±–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: {e}")
            return

    # --- 3) alb_ : —Å—Ç–∞—Ä–∞—è —Å—Å—ã–ª–∫–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é view-only) ---
    if payload.startswith("alb_"):
        code = payload.replace("alb_", "", 1).strip()

        try:
            conn = get_db_connection()
            cur = conn.cursor()

            cur.execute("SELECT name, owner_id FROM albums WHERE invite_code = %s LIMIT 1", (code,))
            row = cur.fetchone()
            if not row:
                cur.close()
                conn.close()
                await message.answer("‚ùå –ê–ª—å–±–æ–º –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å —Å—Å—ã–ª–∫—É.")
                return

            album_name, owner_id = row

            if int(owner_id) != int(user_id):
                cur.execute(
                    """
                    INSERT INTO album_members (album_code, user_id, can_upload, can_delete, username, first_name, last_name)
                    VALUES (%s, %s, FALSE, FALSE, %s, %s, %s)
                    ON CONFLICT (album_code, user_id) DO NOTHING
                    """,
                    (code, user_id, username, first_name, last_name),
                )
                conn.commit()

            cur.close()
            conn.close()

            await message.answer(
                f"‚úÖ –ê–ª—å–±–æ–º ¬´{album_name}¬ª –¥–æ—Å—Ç—É–ø–µ–Ω.\n–û—Ç–∫—Ä–æ–π –º–∏–Ω–∏-–∞–ø–ø: üëá",
                reply_markup=webapp_kb(),
            )
            return

        except Exception as e:
            await message.answer(f"‚ùå –û—à–∏–±–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: {e}")
            return

    # –æ–±—ã—á–Ω—ã–π —Å—Ç–∞—Ä—Ç
    builder = InlineKeyboardBuilder()
    builder.row(types.InlineKeyboardButton(text="üì∏ –°–æ–∑–¥–∞—Ç—å –∞–ª—å–±–æ–º", callback_data="create_album"))
    builder.row(types.InlineKeyboardButton(text="üñº –ú–æ–∏ –∞–ª—å–±–æ–º—ã", web_app=WebAppInfo(url=MINI_APP_URL)))
    await message.answer("Iventry: –°–æ–≤–º–µ—Å—Ç–Ω—ã–µ –∞–ª—å–±–æ–º—ã üì∏", reply_markup=builder.as_markup())


@dp.message(F.text == "‚ùå –û—Ç–º–µ–Ω–∞")
async def cancel_pick(message: types.Message):
    # –ø—Ä–æ—Å—Ç–æ —É–±–∏—Ä–∞–µ–º –∫–ª–∞–≤—É
    await message.answer("–û–∫.", reply_markup=types.ReplyKeyboardRemove())


@dp.message(F.user_shared)
async def on_user_shared(message: types.Message):
    # –æ–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±—Ä–∞–Ω
    us = message.user_shared
    req_id = int(us.request_id)
    data = PENDING_PICK.pop(req_id, None)
    await message.answer("", reply_markup=types.ReplyKeyboardRemove())

    if not data:
        await message.answer("–ó–∞–ø—Ä–æ—Å —É—Å—Ç–∞—Ä–µ–ª. –û—Ç–∫—Ä–æ–π –º–∏–Ω–∏-–∞–ø–ø –∏ –ø–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.")
        return

    album_code = data["album_code"]
    can_upload = bool(data["can_upload"])
    can_delete = bool(data["can_delete"])

    selected_user_id = int(us.user_id)

    # –ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å (–ø–æ–ª—É—á–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –±–æ—Ç –º–æ–∂–µ—Ç get_chat —ç—Ç–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞)
    username = None
    first_name = None
    last_name = None
    try:
        chat = await bot.get_chat(selected_user_id)
        username = getattr(chat, "username", None)
        first_name = getattr(chat, "first_name", None)
        last_name = getattr(chat, "last_name", None)
    except Exception:
        pass

    try:
        conn = get_db_connection()
        cur = conn.cursor()

        owner_id = _get_album_owner(album_code)
        if owner_id is None:
            cur.close()
            conn.close()
            await message.answer("‚ùå –ê–ª—å–±–æ–º –Ω–µ –Ω–∞–π–¥–µ–Ω.")
            return

        if int(owner_id) == int(selected_user_id):
            cur.close()
            conn.close()
            await message.answer("–≠—Ç–æ –≤–ª–∞–¥–µ–ª–µ—Ü –∞–ª—å–±–æ–º–∞ üôÇ")
            return

        cur.execute(
            """
            INSERT INTO album_members (album_code, user_id, can_upload, can_delete, username, first_name, last_name)
            VALUES (%s,%s,%s,%s,%s,%s,%s)
            ON CONFLICT (album_code, user_id)
            DO UPDATE SET
                can_upload = EXCLUDED.can_upload,
                can_delete = EXCLUDED.can_delete,
                username = COALESCE(EXCLUDED.username, album_members.username),
                first_name = COALESCE(EXCLUDED.first_name, album_members.first_name),
                last_name = COALESCE(EXCLUDED.last_name, album_members.last_name)
            """,
            (album_code, selected_user_id, can_upload, can_delete, username, first_name, last_name),
        )
        conn.commit()
        cur.close()
        conn.close()

        rights = []
        if can_upload:
            rights.append("–∑–∞–≥—Ä—É–∑–∫–∞")
        if can_delete:
            rights.append("—É–¥–∞–ª–µ–Ω–∏–µ")
        rights_txt = ", ".join(rights) if rights else "—Ç–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä"

        await message.answer(f"‚úÖ –î–æ–±–∞–≤–∏–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {selected_user_id} –≤ –∞–ª—å–±–æ–º.\n–ü—Ä–∞–≤–∞: {rights_txt}")
    except Exception as e:
        await message.answer(f"‚ùå –û—à–∏–±–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: {e}")


@dp.callback_query(F.data == "create_album")
async def start_create(callback: types.CallbackQuery, state: FSMContext):
    await callback.answer()
    await state.set_state(CreateAlbum.waiting_for_name)
    if callback.message:
        await callback.message.answer("–ö–∞–∫ –Ω–∞–∑–æ–≤—ë–º –∞–ª—å–±–æ–º?")


@dp.message(CreateAlbum.waiting_for_name)
async def name_step(message: types.Message, state: FSMContext):
    name = (message.text or "").strip()
    if not name:
        await message.answer("–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º. –ù–∞–ø–∏—à–∏ –µ—â—ë —Ä–∞–∑ üôÇ")
        return
    if not message.from_user:
        await message.answer("–ù–µ —Å–º–æ–≥ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.")
        return

    code = str(uuid.uuid4())[:8]

    try:
        conn = get_db_connection()
        cur = conn.cursor()
        cur.execute(
            "INSERT INTO albums (name, owner_id, invite_code) VALUES (%s, %s, %s)",
            (name, message.from_user.id, code),
        )
        conn.commit()
        cur.close()
        conn.close()

        await message.answer(
            f"‚úÖ –ê–ª—å–±–æ–º —Å–æ–∑–¥–∞–Ω!\n–ö–æ–¥: `{code}`\n\n–û—Ç–∫—Ä–æ–π –º–∏–Ω–∏-–∞–ø–ø –∏ –Ω–∞–∂–º–∏ ¬´üì§ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è¬ª.",
            parse_mode="Markdown",
        )
        await state.clear()
    except Exception as e:
        await message.answer(f"‚ùå –û—à–∏–±–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: {e}")


async def main():
    await dp.start_polling(bot)


if __name__ == "__main__":
    asyncio.run(main())
